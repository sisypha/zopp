name: Tests & Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-coverage:
    name: unit-coverage
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - uses: Swatinem/rust-cache@v2

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Run unit tests with coverage
        run: ./scripts/unit-coverage.sh
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5433/postgres

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Extract coverage percentage
        id: coverage
        run: |
          # Extract line coverage from the TOTAL row (second-to-last percentage)
          COVERAGE=$(grep "^TOTAL" coverage/summary.txt | awk '{for(i=1;i<=NF;i++) if($i ~ /%$/) last=$i} END{print last}' | tr -d '%')
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Current coverage: $COVERAGE%"

      - name: Fetch baseline coverage
        id: baseline
        run: |
          # Try to fetch baseline from gh-pages branch
          BASELINE=$(curl -sf "https://raw.githubusercontent.com/${{ github.repository }}/gh-pages/coverage-baseline.txt" || echo "0")
          echo "percentage=$BASELINE" >> $GITHUB_OUTPUT
          echo "Baseline coverage: $BASELINE%"

      - name: Check coverage regression
        if: github.event_name == 'pull_request'
        run: |
          CURRENT="${{ steps.coverage.outputs.percentage }}"
          BASELINE="${{ steps.baseline.outputs.percentage }}"

          echo "Current: $CURRENT%, Baseline: $BASELINE%"

          # Use bc for floating point comparison - warn but don't fail
          # This allows the baseline to be reset when measurement methodology changes
          if (( $(echo "$CURRENT < $BASELINE" | bc -l) )); then
            echo "::warning::Coverage decreased from $BASELINE% to $CURRENT%"
          else
            DIFF=$(echo "$CURRENT - $BASELINE" | bc -l)
            echo "Coverage change: +$DIFF%"
          fi

      - name: Post coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.coverage.outputs.percentage }}';
            const baseline = '${{ steps.baseline.outputs.percentage }}';
            const diff = (parseFloat(current) - parseFloat(baseline)).toFixed(2);
            const sign = diff >= 0 ? '+' : '';
            const emoji = diff >= 0 ? ':white_check_mark:' : ':warning:';

            const body = `## ${emoji} Unit Test Coverage

            | Metric | Value |
            |--------|-------|
            | **Current** | ${current}% |
            | **Baseline** | ${baseline}% |
            | **Change** | ${sign}${diff}% |

            <details>
            <summary>View full report</summary>

            Download the \`coverage-report\` artifact or view on [GitHub Pages](https://${{ github.repository_owner }}.github.io/${context.repo.repo}/coverage/html/) after merge.
            </details>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('Unit Test Coverage') && c.user.type === 'Bot');

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Deploy coverage to GitHub Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          COVERAGE="${{ steps.coverage.outputs.percentage }}"

          # Save coverage percentage for baseline
          echo "$COVERAGE" > coverage/coverage-baseline.txt

          # Generate badge JSON for shields.io
          # Color: red < 50, yellow < 80, green >= 80
          if (( $(echo "$COVERAGE < 50" | bc -l) )); then
            COLOR="red"
          elif (( $(echo "$COVERAGE < 80" | bc -l) )); then
            COLOR="yellow"
          else
            COLOR="brightgreen"
          fi

          cat > coverage/badge.json << EOF
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "${COVERAGE}%",
            "color": "${COLOR}"
          }
          EOF

          # Save coverage files before switching branches (coverage/ is a build artifact, not in git)
          mkdir -p /tmp/coverage-deploy
          cp -r coverage/html/* /tmp/coverage-deploy/
          cp coverage/coverage-baseline.txt /tmp/coverage-deploy/
          cp coverage/badge.json /tmp/coverage-deploy/

          # Create/update gh-pages branch
          if git fetch origin gh-pages:gh-pages 2>/dev/null; then
            git checkout gh-pages
            # Clean any untracked files from the checkout
            git clean -fd
          else
            # Create orphan branch for first-time setup
            git checkout --orphan gh-pages
            # Remove all files from index AND working directory
            git rm -rf . 2>/dev/null || true
            # Clean untracked files (build artifacts etc)
            git clean -fdx
          fi

          # Copy coverage files to the branch
          cp /tmp/coverage-deploy/coverage-baseline.txt ./
          cp /tmp/coverage-deploy/badge.json ./
          mkdir -p coverage
          cp -r /tmp/coverage-deploy/* coverage/ 2>/dev/null || true
          rm -f coverage/coverage-baseline.txt coverage/badge.json

          # Commit and push (only add specific files, not everything)
          git add coverage-baseline.txt badge.json coverage/
          git commit -m "Update coverage report for ${{ github.sha }}" || echo "No changes to commit"
          git push origin gh-pages

  e2e:
    name: e2e
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install kind
        run: |
          [ $(uname -m) = x86_64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Build binaries
        run: cargo build --bins

      - name: Run E2E tests
        run: cargo test --package e2e-tests --no-fail-fast -- --test-threads=4
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5433/postgres
          # Skip K8s tests in CI - kind clusters are unreliable in GitHub Actions
          SKIP_K8S_TESTS: "1"
