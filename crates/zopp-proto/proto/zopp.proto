syntax = "proto3";
package zopp;

service ZoppService {
  // Auth
  rpc Join(JoinRequest) returns (JoinResponse);
  rpc Register(RegisterRequest) returns (RegisterResponse);
  rpc Login(LoginRequest) returns (LoginResponse);

  // Email Verification
  rpc VerifyEmail(VerifyEmailRequest) returns (VerifyEmailResponse);
  rpc ResendVerification(ResendVerificationRequest) returns (ResendVerificationResponse);

  // Workspaces
  rpc CreateWorkspace(CreateWorkspaceRequest) returns (Workspace);
  rpc ListWorkspaces(Empty) returns (WorkspaceList);
  rpc GetWorkspaceKeys(GetWorkspaceKeysRequest) returns (WorkspaceKeys);
  rpc GrantPrincipalWorkspaceAccess(GrantPrincipalWorkspaceAccessRequest) returns (Empty);

  // Invites
  rpc CreateInvite(CreateInviteRequest) returns (InviteToken);
  rpc GetInvite(GetInviteRequest) returns (InviteToken);  // Unauthenticated - for joining
  rpc ListInvites(Empty) returns (InviteList);
  rpc RevokeInvite(RevokeInviteRequest) returns (Empty);

  // Principals
  rpc GetPrincipal(GetPrincipalRequest) returns (Principal);
  rpc RenamePrincipal(RenamePrincipalRequest) returns (Empty);
  rpc ListPrincipals(Empty) returns (PrincipalList);
  rpc ListWorkspaceServicePrincipals(ListWorkspaceServicePrincipalsRequest) returns (ServicePrincipalList);
  rpc RemovePrincipalFromWorkspace(RemovePrincipalFromWorkspaceRequest) returns (Empty);
  rpc RevokeAllPrincipalPermissions(RevokeAllPrincipalPermissionsRequest) returns (RevokeAllPrincipalPermissionsResponse);

  // Principal Export/Import (multi-device support)
  rpc CreatePrincipalExport(CreatePrincipalExportRequest) returns (CreatePrincipalExportResponse);
  rpc GetPrincipalExport(GetPrincipalExportRequest) returns (GetPrincipalExportResponse);
  rpc ConsumePrincipalExport(ConsumePrincipalExportRequest) returns (Empty);

  // Projects
  rpc CreateProject(CreateProjectRequest) returns (Project);
  rpc ListProjects(ListProjectsRequest) returns (ProjectList);
  rpc GetProject(GetProjectRequest) returns (Project);
  rpc DeleteProject(DeleteProjectRequest) returns (Empty);

  // Environments
  rpc CreateEnvironment(CreateEnvironmentRequest) returns (Environment);
  rpc ListEnvironments(ListEnvironmentsRequest) returns (EnvironmentList);
  rpc GetEnvironment(GetEnvironmentRequest) returns (Environment);
  rpc DeleteEnvironment(DeleteEnvironmentRequest) returns (Empty);

  // Secrets
  rpc UpsertSecret(UpsertSecretRequest) returns (Empty);
  rpc GetSecret(GetSecretRequest) returns (Secret);
  rpc ListSecrets(ListSecretsRequest) returns (SecretList);
  rpc DeleteSecret(DeleteSecretRequest) returns (Empty);

  // Watch (streaming)
  rpc WatchSecrets(WatchSecretsRequest) returns (stream WatchSecretsResponse);

  // ============================================================================
  // Generic Permissions API (NEW - replaces 36 specific permission methods)
  // ============================================================================
  rpc SetPermission(SetPermissionRequest) returns (Empty);
  rpc GetPermission(GetPermissionRequest) returns (PermissionResponse);
  rpc ListPermissions(ListPermissionsRequest) returns (PermissionListResponse);
  rpc RemovePermission(RemovePermissionRequest) returns (Empty);

  // ============================================================================
  // DEPRECATED: Principal Permissions (use generic SetPermission/GetPermission/etc)
  // These methods will be removed in v1.0
  // ============================================================================
  rpc SetWorkspacePermission(SetWorkspacePermissionRequest) returns (Empty); // Deprecated: use SetPermission
  rpc GetWorkspacePermission(GetWorkspacePermissionRequest) returns (PermissionResponse); // Deprecated: use GetPermission
  rpc ListWorkspacePermissions(ListWorkspacePermissionsRequest) returns (PermissionList); // Deprecated: use ListPermissions
  rpc RemoveWorkspacePermission(RemoveWorkspacePermissionRequest) returns (Empty); // Deprecated: use RemovePermission

  rpc SetProjectPermission(SetProjectPermissionRequest) returns (Empty); // Deprecated: use SetPermission
  rpc GetProjectPermission(GetProjectPermissionRequest) returns (PermissionResponse); // Deprecated: use GetPermission
  rpc ListProjectPermissions(ListProjectPermissionsRequest) returns (PermissionList); // Deprecated: use ListPermissions
  rpc RemoveProjectPermission(RemoveProjectPermissionRequest) returns (Empty); // Deprecated: use RemovePermission

  rpc SetEnvironmentPermission(SetEnvironmentPermissionRequest) returns (Empty); // Deprecated: use SetPermission
  rpc GetEnvironmentPermission(GetEnvironmentPermissionRequest) returns (PermissionResponse); // Deprecated: use GetPermission
  rpc ListEnvironmentPermissions(ListEnvironmentPermissionsRequest) returns (PermissionList); // Deprecated: use ListPermissions
  rpc RemoveEnvironmentPermission(RemoveEnvironmentPermissionRequest) returns (Empty); // Deprecated: use RemovePermission

  // Groups
  rpc CreateGroup(CreateGroupRequest) returns (Group);
  rpc GetGroup(GetGroupRequest) returns (Group);
  rpc ListGroups(ListGroupsRequest) returns (GroupList);
  rpc UpdateGroup(UpdateGroupRequest) returns (Group);
  rpc DeleteGroup(DeleteGroupRequest) returns (Empty);

  // Group Membership
  rpc AddGroupMember(AddGroupMemberRequest) returns (Empty);
  rpc RemoveGroupMember(RemoveGroupMemberRequest) returns (Empty);
  rpc ListGroupMembers(ListGroupMembersRequest) returns (GroupMemberList);
  rpc ListUserGroups(ListUserGroupsRequest) returns (GroupList);

  // ============================================================================
  // DEPRECATED: Group Permissions (use generic SetPermission/GetPermission/etc)
  // These methods will be removed in v1.0
  // ============================================================================
  rpc SetGroupWorkspacePermission(SetGroupWorkspacePermissionRequest) returns (Empty); // Deprecated: use SetPermission
  rpc GetGroupWorkspacePermission(GetGroupWorkspacePermissionRequest) returns (PermissionResponse); // Deprecated: use GetPermission
  rpc ListGroupWorkspacePermissions(ListGroupWorkspacePermissionsRequest) returns (GroupPermissionList); // Deprecated: use ListPermissions
  rpc RemoveGroupWorkspacePermission(RemoveGroupWorkspacePermissionRequest) returns (Empty); // Deprecated: use RemovePermission

  rpc SetGroupProjectPermission(SetGroupProjectPermissionRequest) returns (Empty); // Deprecated: use SetPermission
  rpc GetGroupProjectPermission(GetGroupProjectPermissionRequest) returns (PermissionResponse); // Deprecated: use GetPermission
  rpc ListGroupProjectPermissions(ListGroupProjectPermissionsRequest) returns (GroupPermissionList); // Deprecated: use ListPermissions
  rpc RemoveGroupProjectPermission(RemoveGroupProjectPermissionRequest) returns (Empty); // Deprecated: use RemovePermission

  rpc SetGroupEnvironmentPermission(SetGroupEnvironmentPermissionRequest) returns (Empty); // Deprecated: use SetPermission
  rpc GetGroupEnvironmentPermission(GetGroupEnvironmentPermissionRequest) returns (PermissionResponse); // Deprecated: use GetPermission
  rpc ListGroupEnvironmentPermissions(ListGroupEnvironmentPermissionsRequest) returns (GroupPermissionList); // Deprecated: use ListPermissions
  rpc RemoveGroupEnvironmentPermission(RemoveGroupEnvironmentPermissionRequest) returns (Empty); // Deprecated: use RemovePermission

  // ============================================================================
  // DEPRECATED: User Permissions (use generic SetPermission/GetPermission/etc)
  // These methods will be removed in v1.0
  // ============================================================================
  rpc SetUserWorkspacePermission(SetUserWorkspacePermissionRequest) returns (Empty); // Deprecated: use SetPermission
  rpc GetUserWorkspacePermission(GetUserWorkspacePermissionRequest) returns (PermissionResponse); // Deprecated: use GetPermission
  rpc ListUserWorkspacePermissions(ListUserWorkspacePermissionsRequest) returns (UserPermissionList); // Deprecated: use ListPermissions
  rpc RemoveUserWorkspacePermission(RemoveUserWorkspacePermissionRequest) returns (Empty); // Deprecated: use RemovePermission

  rpc SetUserProjectPermission(SetUserProjectPermissionRequest) returns (Empty); // Deprecated: use SetPermission
  rpc GetUserProjectPermission(GetUserProjectPermissionRequest) returns (PermissionResponse); // Deprecated: use GetPermission
  rpc ListUserProjectPermissions(ListUserProjectPermissionsRequest) returns (UserPermissionList); // Deprecated: use ListPermissions
  rpc RemoveUserProjectPermission(RemoveUserProjectPermissionRequest) returns (Empty); // Deprecated: use RemovePermission

  rpc SetUserEnvironmentPermission(SetUserEnvironmentPermissionRequest) returns (Empty); // Deprecated: use SetPermission
  rpc GetUserEnvironmentPermission(GetUserEnvironmentPermissionRequest) returns (PermissionResponse); // Deprecated: use GetPermission
  rpc ListUserEnvironmentPermissions(ListUserEnvironmentPermissionsRequest) returns (UserPermissionList); // Deprecated: use ListPermissions
  rpc RemoveUserEnvironmentPermission(RemoveUserEnvironmentPermissionRequest) returns (Empty); // Deprecated: use RemovePermission

  // Effective permissions (aggregated view)
  rpc GetEffectivePermissions(GetEffectivePermissionsRequest) returns (EffectivePermissionsResponse);

  // Audit logs
  rpc ListAuditLogs(ListAuditLogsRequest) returns (AuditLogList);
  rpc GetAuditLog(GetAuditLogRequest) returns (AuditLogEntry);
  // CountAuditLogs removed - use ListAuditLogs response.total_count instead

  // Organizations (SaaS cloud feature)
  rpc CreateOrganization(CreateOrganizationRequest) returns (Organization);
  rpc GetOrganization(GetOrganizationRequest) returns (Organization);
  rpc ListUserOrganizations(Empty) returns (OrganizationList);
  rpc UpdateOrganization(UpdateOrganizationRequest) returns (Organization);
  rpc DeleteOrganization(DeleteOrganizationRequest) returns (Empty);

  // Organization members
  rpc UpsertOrganizationMember(UpsertOrganizationMemberRequest) returns (OrganizationMember);
  rpc GetOrganizationMember(GetOrganizationMemberRequest) returns (OrganizationMember);
  rpc ListOrganizationMembers(ListOrganizationMembersRequest) returns (OrganizationMemberList);
  rpc RemoveOrganizationMember(RemoveOrganizationMemberRequest) returns (Empty);
  // DEPRECATED: Use UpsertOrganizationMember instead (will be removed in v1.0)
  rpc AddOrganizationMember(AddOrganizationMemberRequest) returns (Empty); // Deprecated: use UpsertOrganizationMember
  rpc UpdateOrganizationMemberRole(UpdateOrganizationMemberRoleRequest) returns (Empty); // Deprecated: use UpsertOrganizationMember

  // Organization invites
  rpc CreateOrganizationInvite(CreateOrganizationInviteRequest) returns (OrganizationInvite);
  rpc GetOrganizationInvite(GetOrganizationInviteRequest) returns (OrganizationInvite);
  rpc ListOrganizationInvites(ListOrganizationInvitesRequest) returns (OrganizationInviteList);
  rpc AcceptOrganizationInvite(AcceptOrganizationInviteRequest) returns (OrganizationMember);
  rpc DeleteOrganizationInvite(DeleteOrganizationInviteRequest) returns (Empty);

  // Organization workspaces
  rpc LinkWorkspaceToOrganization(LinkWorkspaceToOrganizationRequest) returns (Empty);
  rpc UnlinkWorkspaceFromOrganization(UnlinkWorkspaceFromOrganizationRequest) returns (Empty);
  rpc ListOrganizationWorkspaces(ListOrganizationWorkspacesRequest) returns (WorkspaceList);

  // Billing (SaaS cloud feature)
  rpc GetSubscription(GetSubscriptionRequest) returns (Subscription);
  rpc ListPayments(ListPaymentsRequest) returns (PaymentList);
  rpc CreateCheckoutSession(CreateCheckoutSessionRequest) returns (CheckoutSession);
  rpc CreateBillingPortalSession(CreateBillingPortalSessionRequest) returns (BillingPortalSession);
}

message Empty {}

// Auth messages
message JoinRequest {
  string invite_token = 1;
  string email = 2;
  string principal_name = 3;
  bytes public_key = 4;              // Ed25519 for authentication
  bytes x25519_public_key = 5;       // X25519 for encryption (ECDH)
  bytes ephemeral_pub = 6;           // Ephemeral X25519 public key for wrapping KEK
  bytes kek_wrapped = 7;             // Workspace KEK wrapped for this principal
  bytes kek_nonce = 8;               // 24-byte nonce for wrapping
}

message JoinResponse {
  string user_id = 1;
  optional string principal_id = 2;  // Only set if verification_required=false
  repeated Workspace workspaces = 3;
  bool verification_required = 4;  // If true, client must complete email verification
}

message RegisterRequest {
  string email = 1;
  string principal_name = 2;
  bytes public_key = 3;              // Ed25519 for authentication
  bytes x25519_public_key = 4;       // X25519 for encryption (ECDH)
  bool is_service = 5;               // Service principal (user_id will be NULL)
  // For service principals: workspace to add the principal to (required if is_service=true)
  optional string workspace_name = 6;
  optional bytes ephemeral_pub = 7;  // Ephemeral X25519 public key for wrapping KEK
  optional bytes kek_wrapped = 8;    // Workspace KEK wrapped for new principal
  optional bytes kek_nonce = 9;      // 24-byte nonce for wrapping
}

message RegisterResponse {
  string user_id = 1;
  string principal_id = 2;
}

message LoginRequest {
  string email = 1;
  string principal_name = 2;
  int64 timestamp = 3;
  bytes signature = 4;  // Sign(private_key, timestamp)
}

message LoginResponse {
  string user_id = 1;
  string principal_id = 2;
}

// Email Verification messages
message VerifyEmailRequest {
  string email = 1;
  string code = 2;                   // 6-digit verification code
  string principal_name = 3;         // Principal name to create
  bytes public_key = 4;              // Ed25519 public key for authentication
  bytes x25519_public_key = 5;       // X25519 public key for encryption (ECDH)
  // For workspace invites - KEK wrapping data
  bytes ephemeral_pub = 6;           // Ephemeral X25519 public key for wrapping KEK
  bytes kek_wrapped = 7;             // Workspace KEK wrapped for this principal
  bytes kek_nonce = 8;               // 24-byte nonce for wrapping
}

message VerifyEmailResponse {
  bool success = 1;
  string message = 2;
  int32 attempts_remaining = 3;      // Number of attempts left before code is invalidated
  string user_id = 4;                // User ID (on success)
  string principal_id = 5;           // Created principal ID (on success)
  repeated Workspace workspaces = 6; // Workspaces user now has access to (on success)
}

message ResendVerificationRequest {
  string email = 1;
}

message ResendVerificationResponse {
  bool success = 1;
  string message = 2;
}

// Workspace messages
message CreateWorkspaceRequest {
  string id = 1;                     // Client-generated workspace ID (UUID v7)
  string name = 2;
  bytes ephemeral_pub = 3;           // Ephemeral X25519 public key for wrapping KEK
  bytes kek_wrapped = 4;             // Workspace KEK wrapped for creator
  bytes kek_nonce = 5;               // 24-byte nonce for wrapping
}

message Workspace {
  string id = 1;
  string name = 2;
  int32 project_count = 3;  // Number of projects in this workspace
}

message WorkspaceList {
  repeated Workspace workspaces = 1;
}

message GetWorkspaceKeysRequest {
  string workspace_name = 1;
}

message WorkspaceKeys {
  string workspace_id = 1;  // Workspace ID (for AAD)
  bytes ephemeral_pub = 2;  // Ephemeral X25519 public key for unwrapping
  bytes kek_wrapped = 3;    // Workspace KEK wrapped for requesting principal
  bytes kek_nonce = 4;      // 24-byte nonce for unwrapping
}

message GrantPrincipalWorkspaceAccessRequest {
  string workspace_name = 1;     // Workspace to grant access to
  string principal_id = 2;       // Principal to grant access to
  bytes ephemeral_pub = 3;       // Ephemeral X25519 public key for wrapping KEK
  bytes kek_wrapped = 4;         // Workspace KEK wrapped for the principal
  bytes kek_nonce = 5;           // 24-byte nonce for wrapping
}

// Invite messages
message CreateInviteRequest {
  repeated string workspace_ids = 1;
  int64 expires_at = 2;
  string token = 3;                  // Hex-encoded SHA256 hash of invite secret (for lookup)
  bytes kek_encrypted = 4;           // Workspace KEK encrypted with invite secret
  bytes kek_nonce = 5;               // 24-byte nonce for KEK encryption
}

message InviteToken {
  string id = 1;
  string token = 2;                  // Hex-encoded SHA256 hash of invite secret (for lookup)
  repeated string workspace_ids = 3;
  int64 created_at = 4;
  int64 expires_at = 5;
  bytes kek_encrypted = 6;           // Workspace KEK encrypted with invite secret
  bytes kek_nonce = 7;               // 24-byte nonce for KEK encryption
  string invite_secret = 8;          // Secret to decrypt KEK (only returned on create, hex-encoded)
  optional string user_id = 9;       // If set, only this user can use the invite (self-invite)
}

message GetInviteRequest {
  string token = 1;                  // Hex-encoded SHA256 hash of invite secret
}

message InviteList {
  repeated InviteToken invites = 1;
}

message RevokeInviteRequest {
  string token = 1;                  // Hex-encoded SHA256 hash of invite secret
}

// Principal messages
message GetPrincipalRequest {
  string principal_id = 1;
}

message Principal {
  string id = 1;
  string name = 2;
  bytes public_key = 3;              // Ed25519 for authentication
  bytes x25519_public_key = 4;       // X25519 for encryption (ECDH), optional
}

message RenamePrincipalRequest {
  string principal_id = 1;
  string new_name = 2;
}

message PrincipalList {
  repeated Principal principals = 1;
}

message ListWorkspaceServicePrincipalsRequest {
  string workspace_name = 1;
}

message ServicePrincipal {
  string id = 1;
  string name = 2;
  string created_at = 3;
  // Permissions this service principal has (aggregated from project/env permissions)
  repeated ServicePrincipalPermission permissions = 4;
}

message ServicePrincipalPermission {
  string scope = 1;          // "project:myproject" or "environment:myproject/prod"
  Role role = 2;
}

message ServicePrincipalList {
  repeated ServicePrincipal service_principals = 1;
}

message RemovePrincipalFromWorkspaceRequest {
  string workspace_name = 1;
  string principal_id = 2;
}

message RevokeAllPrincipalPermissionsRequest {
  string workspace_name = 1;
  string principal_id = 2;
}

message RevokeAllPrincipalPermissionsResponse {
  int32 permissions_revoked = 1;
}

// Principal Export/Import messages (multi-device support)
message CreatePrincipalExportRequest {
  string token_hash = 1;        // Argon2id(passphrase, verification_salt) for verification
  bytes verification_salt = 2;  // Salt for passphrase verification (separate from encryption)
  bytes encrypted_data = 3;     // Principal data encrypted with passphrase-derived key
  bytes salt = 4;               // Argon2id salt for encryption key derivation
  bytes nonce = 5;              // XChaCha20-Poly1305 nonce
  int64 expires_at = 6;         // Unix timestamp for expiration
}

message CreatePrincipalExportResponse {
  string export_code = 1;       // Public code for lookup (e.g., "exp_a7k9m2x4")
}

message GetPrincipalExportRequest {
  string export_code = 1;       // Public code for lookup
  string token_hash = 2;        // Argon2id(passphrase, verification_salt) - empty for first request to get salt
}

message GetPrincipalExportResponse {
  string export_id = 1;         // Empty if only returning verification_salt
  bytes verification_salt = 2;  // Salt for passphrase verification (always returned)
  bytes encrypted_data = 3;     // Principal data encrypted with passphrase-derived key (only if verified)
  bytes salt = 4;               // Argon2id salt for encryption key derivation (only if verified)
  bytes nonce = 5;              // XChaCha20-Poly1305 nonce (only if verified)
  int64 expires_at = 6;         // Unix timestamp for expiration
}

message ConsumePrincipalExportRequest {
  string export_code = 1; // Same export_code used in GetPrincipalExport
  string token_hash = 2;  // Argon2id(passphrase, verification_salt) - same verification as GetPrincipalExport
}

// Project messages
message CreateProjectRequest {
  string workspace_name = 1;
  string name = 2;
}

message ListProjectsRequest {
  string workspace_name = 1;
}

message GetProjectRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message DeleteProjectRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message Project {
  string id = 1;
  string workspace_id = 2;
  string name = 3;
  int64 created_at = 4;
  int64 updated_at = 5;
  int32 environment_count = 6;  // Number of environments in this project
}

message ProjectList {
  repeated Project projects = 1;
}

// Environment messages
message CreateEnvironmentRequest {
  string workspace_name = 1;
  string project_name = 2;
  string name = 3;
  bytes dek_wrapped = 4;
  bytes dek_nonce = 5;
}

message ListEnvironmentsRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message GetEnvironmentRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message DeleteEnvironmentRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message Environment {
  string id = 1;
  string project_id = 2;
  string name = 3;
  bytes dek_wrapped = 4;
  bytes dek_nonce = 5;
  int64 created_at = 6;
  int64 updated_at = 7;
  int32 secret_count = 8;  // Number of secrets in this environment
}

message EnvironmentList {
  repeated Environment environments = 1;
}

// Secret messages
message UpsertSecretRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string key = 4;
  bytes nonce = 5;
  bytes ciphertext = 6;
}

message GetSecretRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string key = 4;
}

message DeleteSecretRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string key = 4;
}

message ListSecretsRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message Secret {
  string key = 1;
  bytes nonce = 2;
  bytes ciphertext = 3;
}

message SecretList {
  repeated Secret secrets = 1;
  int64 version = 2;  // Current environment version
}

// Watch messages
message WatchSecretsRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  optional int64 since_version = 4;  // Client's last known version
}

message WatchSecretsResponse {
  oneof response {
    ResyncRequired resync = 1;      // Client is behind, needs full resync
    SecretChangeEvent event = 2;    // Real-time secret change event
  }
}

message ResyncRequired {
  int64 current_version = 1;         // Server's current version
}

message SecretChangeEvent {
  enum EventType {
    CREATED = 0;
    UPDATED = 1;
    DELETED = 2;
  }
  EventType event_type = 1;
  string key = 2;                    // Secret key (for informational/logging purposes)
  int64 version = 3;                 // New version after this change
  int64 timestamp = 4;               // Unix timestamp
}

// RBAC Permission messages
enum Role {
  ROLE_UNSPECIFIED = 0;  // Default value - must be handled as error
  ADMIN = 1;
  WRITE = 2;
  READ = 3;
}

// ============================================================================
// Generic Permissions API types
// ============================================================================

// ResourceType identifies what kind of resource we're setting permissions on
enum ResourceType {
  RESOURCE_TYPE_UNSPECIFIED = 0;
  RESOURCE_WORKSPACE = 1;
  RESOURCE_PROJECT = 2;
  RESOURCE_ENVIRONMENT = 3;
}

// ActorType identifies what kind of actor is being granted permission
enum ActorType {
  ACTOR_TYPE_UNSPECIFIED = 0;
  ACTOR_PRINCIPAL = 1;  // Service principals (direct principal permissions)
  ACTOR_GROUP = 2;      // Group-based permissions
  ACTOR_USER = 3;       // Direct user permissions (by email)
}

// ResourceRef identifies a specific resource
message ResourceRef {
  ResourceType type = 1;
  string workspace_name = 2;              // Always required
  optional string project_name = 3;       // Required for PROJECT and ENVIRONMENT
  optional string environment_name = 4;   // Required for ENVIRONMENT
}

// ActorRef identifies who is being granted permission
message ActorRef {
  ActorType type = 1;
  oneof actor {
    string principal_id = 2;  // For ACTOR_PRINCIPAL
    string group_name = 3;    // For ACTOR_GROUP
    string user_email = 4;    // For ACTOR_USER
  }
}

// SetPermissionRequest - generic permission setter
message SetPermissionRequest {
  ResourceRef resource = 1;
  ActorRef actor = 2;
  Role role = 3;
}

// GetPermissionRequest - generic permission getter
message GetPermissionRequest {
  ResourceRef resource = 1;
  ActorRef actor = 2;
}

// ListPermissionsRequest - list permissions on a resource
message ListPermissionsRequest {
  ResourceRef resource = 1;
  optional ActorType actor_type_filter = 2;  // Filter by actor type (optional)
}

// RemovePermissionRequest - generic permission remover
message RemovePermissionRequest {
  ResourceRef resource = 1;
  ActorRef actor = 2;
}

// PermissionEntry - a single permission in a list
message PermissionEntry {
  ActorRef actor = 1;
  Role role = 2;
  string actor_display_name = 3;  // Human-readable name (principal name, group name, or email)
}

// PermissionListResponse - response from ListPermissions
message PermissionListResponse {
  repeated PermissionEntry permissions = 1;
}

message SetWorkspacePermissionRequest {
  string workspace_name = 1;
  string principal_id = 2;
  Role role = 3;
}

message GetWorkspacePermissionRequest {
  string workspace_name = 1;
  string principal_id = 2;
}

message ListWorkspacePermissionsRequest {
  string workspace_name = 1;
}

message RemoveWorkspacePermissionRequest {
  string workspace_name = 1;
  string principal_id = 2;
}

message SetProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string principal_id = 3;
  Role role = 4;
}

message GetProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string principal_id = 3;
}

message ListProjectPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message RemoveProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string principal_id = 3;
}

message SetEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string principal_id = 4;
  Role role = 5;
}

message GetEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string principal_id = 4;
}

message ListEnvironmentPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message RemoveEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string principal_id = 4;
}

message PermissionResponse {
  Role role = 1;
}

message Permission {
  string principal_id = 1;
  string principal_name = 2;
  Role role = 3;
}

message PermissionList {
  repeated Permission permissions = 1;
}

// Group messages
message Group {
  string id = 1;
  string workspace_id = 2;
  string name = 3;
  string description = 4;
  string created_at = 5;
  string updated_at = 6;
}

message CreateGroupRequest {
  string workspace_name = 1;
  string name = 2;
  string description = 3;
}

message GetGroupRequest {
  string workspace_name = 1;
  string group_name = 2;
}

message ListGroupsRequest {
  string workspace_name = 1;
}

message UpdateGroupRequest {
  string workspace_name = 1;
  string group_name = 2;
  string new_name = 3;
  string new_description = 4;
}

message DeleteGroupRequest {
  string workspace_name = 1;
  string group_name = 2;
}

message GroupList {
  repeated Group groups = 1;
}

// Group membership messages
message AddGroupMemberRequest {
  string workspace_name = 1;
  string group_name = 2;
  string user_email = 3;
}

message RemoveGroupMemberRequest {
  string workspace_name = 1;
  string group_name = 2;
  string user_email = 3;
}

message ListGroupMembersRequest {
  string workspace_name = 1;
  string group_name = 2;
}

message ListUserGroupsRequest {
  string workspace_name = 1;
  string user_email = 2;
}

message GroupMember {
  string user_id = 1;
  string user_email = 2;
  string created_at = 3;
}

message GroupMemberList {
  repeated GroupMember members = 1;
}

// Group permission messages
message SetGroupWorkspacePermissionRequest {
  string workspace_name = 1;
  string group_name = 2;
  Role role = 3;
}

message GetGroupWorkspacePermissionRequest {
  string workspace_name = 1;
  string group_name = 2;
}

message ListGroupWorkspacePermissionsRequest {
  string workspace_name = 1;
}

message RemoveGroupWorkspacePermissionRequest {
  string workspace_name = 1;
  string group_name = 2;
}

message SetGroupProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string group_name = 3;
  Role role = 4;
}

message GetGroupProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string group_name = 3;
}

message ListGroupProjectPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message RemoveGroupProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string group_name = 3;
}

message SetGroupEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string group_name = 4;
  Role role = 5;
}

message GetGroupEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string group_name = 4;
}

message ListGroupEnvironmentPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message RemoveGroupEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string group_name = 4;
}

message GroupPermission {
  string group_id = 1;
  string group_name = 2;
  Role role = 3;
}

message GroupPermissionList {
  repeated GroupPermission permissions = 1;
}

// User permission messages (direct user permissions, not via groups)
message SetUserWorkspacePermissionRequest {
  string workspace_name = 1;
  string user_email = 2;
  Role role = 3;
}

message GetUserWorkspacePermissionRequest {
  string workspace_name = 1;
  string user_email = 2;
}

message ListUserWorkspacePermissionsRequest {
  string workspace_name = 1;
}

message RemoveUserWorkspacePermissionRequest {
  string workspace_name = 1;
  string user_email = 2;
}

message SetUserProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string user_email = 3;
  Role role = 4;
}

message GetUserProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string user_email = 3;
}

message ListUserProjectPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message RemoveUserProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string user_email = 3;
}

message SetUserEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string user_email = 4;
  Role role = 5;
}

message GetUserEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string user_email = 4;
}

message ListUserEnvironmentPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message RemoveUserEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string user_email = 4;
}

message UserPermission {
  string user_id = 1;
  string user_email = 2;
  Role role = 3;
}

message UserPermissionList {
  repeated UserPermission permissions = 1;
}

// Effective permissions messages
message GetEffectivePermissionsRequest {
  string workspace_name = 1;
  string principal_id = 2;
}

message EffectivePermissionsResponse {
  string principal_id = 1;
  string principal_name = 2;
  bool is_service_principal = 3;
  // Workspace-level effective role (if any)
  optional Role workspace_role = 4;
  // Project-level effective roles
  repeated EffectiveProjectPermission projects = 5;
}

message EffectiveProjectPermission {
  string project_id = 1;
  string project_name = 2;
  optional Role effective_role = 3;
  // Environment-level effective roles within this project
  repeated EffectiveEnvironmentPermission environments = 4;
}

message EffectiveEnvironmentPermission {
  string environment_id = 1;
  string environment_name = 2;
  Role effective_role = 3;
}

// Audit log messages
message AuditLogEntry {
  string id = 1;
  string timestamp = 2;
  string principal_id = 3;
  optional string user_id = 4;
  string action = 5;
  string resource_type = 6;
  string resource_id = 7;
  optional string workspace_id = 8;
  optional string project_id = 9;
  optional string environment_id = 10;
  string result = 11;
  optional string reason = 12;
  optional string details = 13; // JSON string
  optional string client_ip = 14;
}

message AuditLogList {
  repeated AuditLogEntry entries = 1;
  uint64 total_count = 2;
}

message ListAuditLogsRequest {
  string workspace_name = 1;
  optional string principal_id = 2;
  optional string user_id = 3;
  optional string project_name = 4;
  optional string environment_name = 5;
  optional string action = 6;
  optional string result = 7;
  optional string from_timestamp = 8;
  optional string to_timestamp = 9;
  optional uint32 limit = 10;
  optional uint32 offset = 11;
}

message GetAuditLogRequest {
  string workspace_name = 1;
  string audit_log_id = 2;
}

message CountAuditLogsRequest {
  string workspace_name = 1;
  optional string principal_id = 2;
  optional string user_id = 3;
  optional string project_name = 4;
  optional string environment_name = 5;
  optional string action = 6;
  optional string result = 7;
  optional string from_timestamp = 8;
  optional string to_timestamp = 9;
}

message CountAuditLogsResponse {
  uint64 count = 1;
}

// Organization messages (SaaS cloud feature)
enum OrganizationRole {
  ORGANIZATION_ROLE_UNSPECIFIED = 0;
  ORGANIZATION_OWNER = 1;   // Full control, billing, can delete org
  ORGANIZATION_ADMIN = 2;   // Manage members, settings, but not billing
  ORGANIZATION_MEMBER = 3;  // Access to org workspaces based on permissions
}

enum Plan {
  PLAN_UNSPECIFIED = 0;
  PLAN_FREE = 1;
  PLAN_PRO = 2;
  PLAN_ENTERPRISE = 3;
}

message Organization {
  string id = 1;
  string name = 2;
  string slug = 3;
  Plan plan = 4;
  int32 seat_limit = 5;
  int32 member_count = 6;
  optional string stripe_customer_id = 7;
  optional string trial_ends_at = 8;  // ISO8601 timestamp
  string created_at = 9;
  string updated_at = 10;
}

message OrganizationList {
  repeated Organization organizations = 1;
}

message CreateOrganizationRequest {
  string name = 1;
  string slug = 2;  // URL-friendly identifier
}

message GetOrganizationRequest {
  oneof identifier {
    string id = 1;
    string slug = 2;
  }
}

message UpdateOrganizationRequest {
  string organization_id = 1;
  optional string name = 2;
  optional string slug = 3;
}

message DeleteOrganizationRequest {
  string organization_id = 1;
}

// Organization member messages
message OrganizationMember {
  string user_id = 1;
  string email = 2;
  OrganizationRole role = 3;
  optional string invited_by = 4;  // User ID of inviter
  string joined_at = 5;  // ISO8601 timestamp
}

message OrganizationMemberList {
  repeated OrganizationMember members = 1;
}

message AddOrganizationMemberRequest {
  string organization_id = 1;
  string user_id = 2;
  OrganizationRole role = 3;
}

// UpsertOrganizationMemberRequest - add or update a member in one call
message UpsertOrganizationMemberRequest {
  string organization_id = 1;
  string user_id = 2;
  OrganizationRole role = 3;
}

message GetOrganizationMemberRequest {
  string organization_id = 1;
  string user_id = 2;
}

message ListOrganizationMembersRequest {
  string organization_id = 1;
}

message UpdateOrganizationMemberRoleRequest {
  string organization_id = 1;
  string user_id = 2;
  OrganizationRole role = 3;
}

message RemoveOrganizationMemberRequest {
  string organization_id = 1;
  string user_id = 2;
}

// Organization invite messages
message OrganizationInvite {
  string id = 1;
  string organization_id = 2;
  string email = 3;
  OrganizationRole role = 4;
  string invited_by = 5;  // User ID of inviter
  string expires_at = 6;  // ISO8601 timestamp
  string created_at = 7;
  // Token only returned on create
  optional string token = 8;
}

message OrganizationInviteList {
  repeated OrganizationInvite invites = 1;
}

message CreateOrganizationInviteRequest {
  string organization_id = 1;
  string email = 2;
  OrganizationRole role = 3;
  optional int64 expires_in_hours = 4;  // Default 72 hours
}

message GetOrganizationInviteRequest {
  string token = 1;  // Invite token for lookup
}

message ListOrganizationInvitesRequest {
  string organization_id = 1;
}

message AcceptOrganizationInviteRequest {
  string token = 1;
}

message DeleteOrganizationInviteRequest {
  string invite_id = 1;
}

// Organization workspace messages
message LinkWorkspaceToOrganizationRequest {
  string organization_id = 1;
  string workspace_id = 2;
}

message UnlinkWorkspaceFromOrganizationRequest {
  string workspace_id = 1;
}

message ListOrganizationWorkspacesRequest {
  string organization_id = 1;
}

// Billing messages (SaaS cloud feature)
enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0;
  SUBSCRIPTION_ACTIVE = 1;
  SUBSCRIPTION_PAST_DUE = 2;
  SUBSCRIPTION_CANCELED = 3;
  SUBSCRIPTION_TRIALING = 4;
  SUBSCRIPTION_INCOMPLETE = 5;
}

enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0;
  PAYMENT_SUCCEEDED = 1;
  PAYMENT_PENDING = 2;
  PAYMENT_FAILED = 3;
  PAYMENT_REFUNDED = 4;
}

message Subscription {
  string id = 1;
  string organization_id = 2;
  string stripe_subscription_id = 3;
  string stripe_price_id = 4;
  Plan plan = 5;
  SubscriptionStatus status = 6;
  string current_period_start = 7;  // ISO8601 timestamp
  string current_period_end = 8;    // ISO8601 timestamp
  bool cancel_at_period_end = 9;
  optional string canceled_at = 10; // ISO8601 timestamp
  string created_at = 11;
  string updated_at = 12;
}

message GetSubscriptionRequest {
  string organization_id = 1;
}

message Payment {
  string id = 1;
  string organization_id = 2;
  optional string stripe_payment_intent_id = 3;
  optional string stripe_invoice_id = 4;
  int64 amount_cents = 5;
  string currency = 6;
  PaymentStatus status = 7;
  optional string description = 8;
  string created_at = 9;
}

message PaymentList {
  repeated Payment payments = 1;
}

message ListPaymentsRequest {
  string organization_id = 1;
  optional int32 limit = 2;
  optional int32 offset = 3;
}

message CheckoutSession {
  string url = 1;  // Stripe Checkout URL
}

message CreateCheckoutSessionRequest {
  string organization_id = 1;
  Plan plan = 2;
  string success_url = 3;  // Redirect URL on success
  string cancel_url = 4;   // Redirect URL on cancel
}

message BillingPortalSession {
  string url = 1;  // Stripe Billing Portal URL
}

message CreateBillingPortalSessionRequest {
  string organization_id = 1;
  string return_url = 2;  // URL to return to after portal session
}
