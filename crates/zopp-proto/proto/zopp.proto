syntax = "proto3";
package zopp;

service ZoppService {
  // Auth
  rpc Join(JoinRequest) returns (JoinResponse);
  rpc Register(RegisterRequest) returns (RegisterResponse);
  rpc Login(LoginRequest) returns (LoginResponse);

  // Workspaces
  rpc CreateWorkspace(CreateWorkspaceRequest) returns (Workspace);
  rpc ListWorkspaces(Empty) returns (WorkspaceList);
  rpc GetWorkspaceKeys(GetWorkspaceKeysRequest) returns (WorkspaceKeys);
  rpc GrantPrincipalWorkspaceAccess(GrantPrincipalWorkspaceAccessRequest) returns (Empty);

  // Invites
  rpc CreateInvite(CreateInviteRequest) returns (InviteToken);
  rpc GetInvite(GetInviteRequest) returns (InviteToken);  // Unauthenticated - for joining
  rpc ListInvites(Empty) returns (InviteList);
  rpc RevokeInvite(RevokeInviteRequest) returns (Empty);

  // Principals
  rpc GetPrincipal(GetPrincipalRequest) returns (Principal);
  rpc RenamePrincipal(RenamePrincipalRequest) returns (Empty);
  rpc ListPrincipals(Empty) returns (PrincipalList);
  rpc ListWorkspaceServicePrincipals(ListWorkspaceServicePrincipalsRequest) returns (ServicePrincipalList);
  rpc RemovePrincipalFromWorkspace(RemovePrincipalFromWorkspaceRequest) returns (Empty);
  rpc RevokeAllPrincipalPermissions(RevokeAllPrincipalPermissionsRequest) returns (RevokeAllPrincipalPermissionsResponse);

  // Principal Export/Import (multi-device support)
  rpc CreatePrincipalExport(CreatePrincipalExportRequest) returns (CreatePrincipalExportResponse);
  rpc GetPrincipalExport(GetPrincipalExportRequest) returns (GetPrincipalExportResponse);
  rpc ConsumePrincipalExport(ConsumePrincipalExportRequest) returns (Empty);

  // Projects
  rpc CreateProject(CreateProjectRequest) returns (Project);
  rpc ListProjects(ListProjectsRequest) returns (ProjectList);
  rpc GetProject(GetProjectRequest) returns (Project);
  rpc DeleteProject(DeleteProjectRequest) returns (Empty);

  // Environments
  rpc CreateEnvironment(CreateEnvironmentRequest) returns (Environment);
  rpc ListEnvironments(ListEnvironmentsRequest) returns (EnvironmentList);
  rpc GetEnvironment(GetEnvironmentRequest) returns (Environment);
  rpc DeleteEnvironment(DeleteEnvironmentRequest) returns (Empty);

  // Secrets
  rpc UpsertSecret(UpsertSecretRequest) returns (Empty);
  rpc GetSecret(GetSecretRequest) returns (Secret);
  rpc ListSecrets(ListSecretsRequest) returns (SecretList);
  rpc DeleteSecret(DeleteSecretRequest) returns (Empty);

  // Watch (streaming)
  rpc WatchSecrets(WatchSecretsRequest) returns (stream WatchSecretsResponse);

  // RBAC Permissions
  rpc SetWorkspacePermission(SetWorkspacePermissionRequest) returns (Empty);
  rpc GetWorkspacePermission(GetWorkspacePermissionRequest) returns (PermissionResponse);
  rpc ListWorkspacePermissions(ListWorkspacePermissionsRequest) returns (PermissionList);
  rpc RemoveWorkspacePermission(RemoveWorkspacePermissionRequest) returns (Empty);

  rpc SetProjectPermission(SetProjectPermissionRequest) returns (Empty);
  rpc GetProjectPermission(GetProjectPermissionRequest) returns (PermissionResponse);
  rpc ListProjectPermissions(ListProjectPermissionsRequest) returns (PermissionList);
  rpc RemoveProjectPermission(RemoveProjectPermissionRequest) returns (Empty);

  rpc SetEnvironmentPermission(SetEnvironmentPermissionRequest) returns (Empty);
  rpc GetEnvironmentPermission(GetEnvironmentPermissionRequest) returns (PermissionResponse);
  rpc ListEnvironmentPermissions(ListEnvironmentPermissionsRequest) returns (PermissionList);
  rpc RemoveEnvironmentPermission(RemoveEnvironmentPermissionRequest) returns (Empty);

  // Groups
  rpc CreateGroup(CreateGroupRequest) returns (Group);
  rpc GetGroup(GetGroupRequest) returns (Group);
  rpc ListGroups(ListGroupsRequest) returns (GroupList);
  rpc UpdateGroup(UpdateGroupRequest) returns (Group);
  rpc DeleteGroup(DeleteGroupRequest) returns (Empty);

  // Group Membership
  rpc AddGroupMember(AddGroupMemberRequest) returns (Empty);
  rpc RemoveGroupMember(RemoveGroupMemberRequest) returns (Empty);
  rpc ListGroupMembers(ListGroupMembersRequest) returns (GroupMemberList);
  rpc ListUserGroups(ListUserGroupsRequest) returns (GroupList);

  // Group Permissions
  rpc SetGroupWorkspacePermission(SetGroupWorkspacePermissionRequest) returns (Empty);
  rpc GetGroupWorkspacePermission(GetGroupWorkspacePermissionRequest) returns (PermissionResponse);
  rpc ListGroupWorkspacePermissions(ListGroupWorkspacePermissionsRequest) returns (GroupPermissionList);
  rpc RemoveGroupWorkspacePermission(RemoveGroupWorkspacePermissionRequest) returns (Empty);

  rpc SetGroupProjectPermission(SetGroupProjectPermissionRequest) returns (Empty);
  rpc GetGroupProjectPermission(GetGroupProjectPermissionRequest) returns (PermissionResponse);
  rpc ListGroupProjectPermissions(ListGroupProjectPermissionsRequest) returns (GroupPermissionList);
  rpc RemoveGroupProjectPermission(RemoveGroupProjectPermissionRequest) returns (Empty);

  rpc SetGroupEnvironmentPermission(SetGroupEnvironmentPermissionRequest) returns (Empty);
  rpc GetGroupEnvironmentPermission(GetGroupEnvironmentPermissionRequest) returns (PermissionResponse);
  rpc ListGroupEnvironmentPermissions(ListGroupEnvironmentPermissionsRequest) returns (GroupPermissionList);
  rpc RemoveGroupEnvironmentPermission(RemoveGroupEnvironmentPermissionRequest) returns (Empty);

  // User Permissions (direct user access, not via groups)
  rpc SetUserWorkspacePermission(SetUserWorkspacePermissionRequest) returns (Empty);
  rpc GetUserWorkspacePermission(GetUserWorkspacePermissionRequest) returns (PermissionResponse);
  rpc ListUserWorkspacePermissions(ListUserWorkspacePermissionsRequest) returns (UserPermissionList);
  rpc RemoveUserWorkspacePermission(RemoveUserWorkspacePermissionRequest) returns (Empty);

  rpc SetUserProjectPermission(SetUserProjectPermissionRequest) returns (Empty);
  rpc GetUserProjectPermission(GetUserProjectPermissionRequest) returns (PermissionResponse);
  rpc ListUserProjectPermissions(ListUserProjectPermissionsRequest) returns (UserPermissionList);
  rpc RemoveUserProjectPermission(RemoveUserProjectPermissionRequest) returns (Empty);

  rpc SetUserEnvironmentPermission(SetUserEnvironmentPermissionRequest) returns (Empty);
  rpc GetUserEnvironmentPermission(GetUserEnvironmentPermissionRequest) returns (PermissionResponse);
  rpc ListUserEnvironmentPermissions(ListUserEnvironmentPermissionsRequest) returns (UserPermissionList);
  rpc RemoveUserEnvironmentPermission(RemoveUserEnvironmentPermissionRequest) returns (Empty);

  // Effective permissions (aggregated view)
  rpc GetEffectivePermissions(GetEffectivePermissionsRequest) returns (EffectivePermissionsResponse);

  // Audit logs
  rpc ListAuditLogs(ListAuditLogsRequest) returns (AuditLogList);
  rpc GetAuditLog(GetAuditLogRequest) returns (AuditLogEntry);
  rpc CountAuditLogs(CountAuditLogsRequest) returns (CountAuditLogsResponse);
}

message Empty {}

// Auth messages
message JoinRequest {
  string invite_token = 1;
  string email = 2;
  string principal_name = 3;
  bytes public_key = 4;              // Ed25519 for authentication
  bytes x25519_public_key = 5;       // X25519 for encryption (ECDH)
  bytes ephemeral_pub = 6;           // Ephemeral X25519 public key for wrapping KEK
  bytes kek_wrapped = 7;             // Workspace KEK wrapped for this principal
  bytes kek_nonce = 8;               // 24-byte nonce for wrapping
}

message JoinResponse {
  string user_id = 1;
  string principal_id = 2;
  repeated Workspace workspaces = 3;
}

message RegisterRequest {
  string email = 1;
  string principal_name = 2;
  bytes public_key = 3;              // Ed25519 for authentication
  bytes x25519_public_key = 4;       // X25519 for encryption (ECDH)
  bool is_service = 5;               // Service principal (user_id will be NULL)
  // For service principals: workspace to add the principal to (required if is_service=true)
  optional string workspace_name = 6;
  optional bytes ephemeral_pub = 7;  // Ephemeral X25519 public key for wrapping KEK
  optional bytes kek_wrapped = 8;    // Workspace KEK wrapped for new principal
  optional bytes kek_nonce = 9;      // 24-byte nonce for wrapping
}

message RegisterResponse {
  string user_id = 1;
  string principal_id = 2;
}

message LoginRequest {
  string email = 1;
  string principal_name = 2;
  int64 timestamp = 3;
  bytes signature = 4;  // Sign(private_key, timestamp)
}

message LoginResponse {
  string user_id = 1;
  string principal_id = 2;
}

// Workspace messages
message CreateWorkspaceRequest {
  string id = 1;                     // Client-generated workspace ID (UUID v7)
  string name = 2;
  bytes ephemeral_pub = 3;           // Ephemeral X25519 public key for wrapping KEK
  bytes kek_wrapped = 4;             // Workspace KEK wrapped for creator
  bytes kek_nonce = 5;               // 24-byte nonce for wrapping
}

message Workspace {
  string id = 1;
  string name = 2;
}

message WorkspaceList {
  repeated Workspace workspaces = 1;
}

message GetWorkspaceKeysRequest {
  string workspace_name = 1;
}

message WorkspaceKeys {
  string workspace_id = 1;  // Workspace ID (for AAD)
  bytes ephemeral_pub = 2;  // Ephemeral X25519 public key for unwrapping
  bytes kek_wrapped = 3;    // Workspace KEK wrapped for requesting principal
  bytes kek_nonce = 4;      // 24-byte nonce for unwrapping
}

message GrantPrincipalWorkspaceAccessRequest {
  string workspace_name = 1;     // Workspace to grant access to
  string principal_id = 2;       // Principal to grant access to
  bytes ephemeral_pub = 3;       // Ephemeral X25519 public key for wrapping KEK
  bytes kek_wrapped = 4;         // Workspace KEK wrapped for the principal
  bytes kek_nonce = 5;           // 24-byte nonce for wrapping
}

// Invite messages
message CreateInviteRequest {
  repeated string workspace_ids = 1;
  int64 expires_at = 2;
  string token = 3;                  // Hex-encoded SHA256 hash of invite secret (for lookup)
  bytes kek_encrypted = 4;           // Workspace KEK encrypted with invite secret
  bytes kek_nonce = 5;               // 24-byte nonce for KEK encryption
}

message InviteToken {
  string id = 1;
  string token = 2;                  // Hex-encoded SHA256 hash of invite secret (for lookup)
  repeated string workspace_ids = 3;
  int64 created_at = 4;
  int64 expires_at = 5;
  bytes kek_encrypted = 6;           // Workspace KEK encrypted with invite secret
  bytes kek_nonce = 7;               // 24-byte nonce for KEK encryption
  string invite_secret = 8;          // Secret to decrypt KEK (only returned on create, hex-encoded)
  optional string user_id = 9;       // If set, only this user can use the invite (self-invite)
}

message GetInviteRequest {
  string token = 1;                  // Hex-encoded SHA256 hash of invite secret
}

message InviteList {
  repeated InviteToken invites = 1;
}

message RevokeInviteRequest {
  string token = 1;                  // Hex-encoded SHA256 hash of invite secret
}

// Principal messages
message GetPrincipalRequest {
  string principal_id = 1;
}

message Principal {
  string id = 1;
  string name = 2;
  bytes public_key = 3;              // Ed25519 for authentication
  bytes x25519_public_key = 4;       // X25519 for encryption (ECDH), optional
}

message RenamePrincipalRequest {
  string principal_id = 1;
  string new_name = 2;
}

message PrincipalList {
  repeated Principal principals = 1;
}

message ListWorkspaceServicePrincipalsRequest {
  string workspace_name = 1;
}

message ServicePrincipal {
  string id = 1;
  string name = 2;
  string created_at = 3;
  // Permissions this service principal has (aggregated from project/env permissions)
  repeated ServicePrincipalPermission permissions = 4;
}

message ServicePrincipalPermission {
  string scope = 1;          // "project:myproject" or "environment:myproject/prod"
  Role role = 2;
}

message ServicePrincipalList {
  repeated ServicePrincipal service_principals = 1;
}

message RemovePrincipalFromWorkspaceRequest {
  string workspace_name = 1;
  string principal_id = 2;
}

message RevokeAllPrincipalPermissionsRequest {
  string workspace_name = 1;
  string principal_id = 2;
}

message RevokeAllPrincipalPermissionsResponse {
  int32 permissions_revoked = 1;
}

// Principal Export/Import messages (multi-device support)
message CreatePrincipalExportRequest {
  string token_hash = 1;        // Argon2id(passphrase, verification_salt) for verification
  bytes verification_salt = 2;  // Salt for passphrase verification (separate from encryption)
  bytes encrypted_data = 3;     // Principal data encrypted with passphrase-derived key
  bytes salt = 4;               // Argon2id salt for encryption key derivation
  bytes nonce = 5;              // XChaCha20-Poly1305 nonce
  int64 expires_at = 6;         // Unix timestamp for expiration
}

message CreatePrincipalExportResponse {
  string export_code = 1;       // Public code for lookup (e.g., "exp_a7k9m2x4")
}

message GetPrincipalExportRequest {
  string export_code = 1;       // Public code for lookup
  string token_hash = 2;        // Argon2id(passphrase, verification_salt) - empty for first request to get salt
}

message GetPrincipalExportResponse {
  string export_id = 1;         // Empty if only returning verification_salt
  bytes verification_salt = 2;  // Salt for passphrase verification (always returned)
  bytes encrypted_data = 3;     // Principal data encrypted with passphrase-derived key (only if verified)
  bytes salt = 4;               // Argon2id salt for encryption key derivation (only if verified)
  bytes nonce = 5;              // XChaCha20-Poly1305 nonce (only if verified)
  int64 expires_at = 6;         // Unix timestamp for expiration
}

message ConsumePrincipalExportRequest {
  string export_code = 1; // Same export_code used in GetPrincipalExport
  string token_hash = 2;  // Argon2id(passphrase, verification_salt) - same verification as GetPrincipalExport
}

// Project messages
message CreateProjectRequest {
  string workspace_name = 1;
  string name = 2;
}

message ListProjectsRequest {
  string workspace_name = 1;
}

message GetProjectRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message DeleteProjectRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message Project {
  string id = 1;
  string workspace_id = 2;
  string name = 3;
  int64 created_at = 4;
  int64 updated_at = 5;
}

message ProjectList {
  repeated Project projects = 1;
}

// Environment messages
message CreateEnvironmentRequest {
  string workspace_name = 1;
  string project_name = 2;
  string name = 3;
  bytes dek_wrapped = 4;
  bytes dek_nonce = 5;
}

message ListEnvironmentsRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message GetEnvironmentRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message DeleteEnvironmentRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message Environment {
  string id = 1;
  string project_id = 2;
  string name = 3;
  bytes dek_wrapped = 4;
  bytes dek_nonce = 5;
  int64 created_at = 6;
  int64 updated_at = 7;
}

message EnvironmentList {
  repeated Environment environments = 1;
}

// Secret messages
message UpsertSecretRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string key = 4;
  bytes nonce = 5;
  bytes ciphertext = 6;
}

message GetSecretRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string key = 4;
}

message DeleteSecretRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string key = 4;
}

message ListSecretsRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message Secret {
  string key = 1;
  bytes nonce = 2;
  bytes ciphertext = 3;
}

message SecretList {
  repeated Secret secrets = 1;
  int64 version = 2;  // Current environment version
}

// Watch messages
message WatchSecretsRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  optional int64 since_version = 4;  // Client's last known version
}

message WatchSecretsResponse {
  oneof response {
    ResyncRequired resync = 1;      // Client is behind, needs full resync
    SecretChangeEvent event = 2;    // Real-time secret change event
  }
}

message ResyncRequired {
  int64 current_version = 1;         // Server's current version
}

message SecretChangeEvent {
  enum EventType {
    CREATED = 0;
    UPDATED = 1;
    DELETED = 2;
  }
  EventType event_type = 1;
  string key = 2;                    // Secret key (for informational/logging purposes)
  int64 version = 3;                 // New version after this change
  int64 timestamp = 4;               // Unix timestamp
}

// RBAC Permission messages
enum Role {
  ROLE_UNSPECIFIED = 0;  // Default value - must be handled as error
  ADMIN = 1;
  WRITE = 2;
  READ = 3;
}

message SetWorkspacePermissionRequest {
  string workspace_name = 1;
  string principal_id = 2;
  Role role = 3;
}

message GetWorkspacePermissionRequest {
  string workspace_name = 1;
  string principal_id = 2;
}

message ListWorkspacePermissionsRequest {
  string workspace_name = 1;
}

message RemoveWorkspacePermissionRequest {
  string workspace_name = 1;
  string principal_id = 2;
}

message SetProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string principal_id = 3;
  Role role = 4;
}

message GetProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string principal_id = 3;
}

message ListProjectPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message RemoveProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string principal_id = 3;
}

message SetEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string principal_id = 4;
  Role role = 5;
}

message GetEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string principal_id = 4;
}

message ListEnvironmentPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message RemoveEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string principal_id = 4;
}

message PermissionResponse {
  Role role = 1;
}

message Permission {
  string principal_id = 1;
  string principal_name = 2;
  Role role = 3;
}

message PermissionList {
  repeated Permission permissions = 1;
}

// Group messages
message Group {
  string id = 1;
  string workspace_id = 2;
  string name = 3;
  string description = 4;
  string created_at = 5;
  string updated_at = 6;
}

message CreateGroupRequest {
  string workspace_name = 1;
  string name = 2;
  string description = 3;
}

message GetGroupRequest {
  string workspace_name = 1;
  string group_name = 2;
}

message ListGroupsRequest {
  string workspace_name = 1;
}

message UpdateGroupRequest {
  string workspace_name = 1;
  string group_name = 2;
  string new_name = 3;
  string new_description = 4;
}

message DeleteGroupRequest {
  string workspace_name = 1;
  string group_name = 2;
}

message GroupList {
  repeated Group groups = 1;
}

// Group membership messages
message AddGroupMemberRequest {
  string workspace_name = 1;
  string group_name = 2;
  string user_email = 3;
}

message RemoveGroupMemberRequest {
  string workspace_name = 1;
  string group_name = 2;
  string user_email = 3;
}

message ListGroupMembersRequest {
  string workspace_name = 1;
  string group_name = 2;
}

message ListUserGroupsRequest {
  string workspace_name = 1;
  string user_email = 2;
}

message GroupMember {
  string user_id = 1;
  string user_email = 2;
  string created_at = 3;
}

message GroupMemberList {
  repeated GroupMember members = 1;
}

// Group permission messages
message SetGroupWorkspacePermissionRequest {
  string workspace_name = 1;
  string group_name = 2;
  Role role = 3;
}

message GetGroupWorkspacePermissionRequest {
  string workspace_name = 1;
  string group_name = 2;
}

message ListGroupWorkspacePermissionsRequest {
  string workspace_name = 1;
}

message RemoveGroupWorkspacePermissionRequest {
  string workspace_name = 1;
  string group_name = 2;
}

message SetGroupProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string group_name = 3;
  Role role = 4;
}

message GetGroupProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string group_name = 3;
}

message ListGroupProjectPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message RemoveGroupProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string group_name = 3;
}

message SetGroupEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string group_name = 4;
  Role role = 5;
}

message GetGroupEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string group_name = 4;
}

message ListGroupEnvironmentPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message RemoveGroupEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string group_name = 4;
}

message GroupPermission {
  string group_id = 1;
  string group_name = 2;
  Role role = 3;
}

message GroupPermissionList {
  repeated GroupPermission permissions = 1;
}

// User permission messages (direct user permissions, not via groups)
message SetUserWorkspacePermissionRequest {
  string workspace_name = 1;
  string user_email = 2;
  Role role = 3;
}

message GetUserWorkspacePermissionRequest {
  string workspace_name = 1;
  string user_email = 2;
}

message ListUserWorkspacePermissionsRequest {
  string workspace_name = 1;
}

message RemoveUserWorkspacePermissionRequest {
  string workspace_name = 1;
  string user_email = 2;
}

message SetUserProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string user_email = 3;
  Role role = 4;
}

message GetUserProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string user_email = 3;
}

message ListUserProjectPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
}

message RemoveUserProjectPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string user_email = 3;
}

message SetUserEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string user_email = 4;
  Role role = 5;
}

message GetUserEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string user_email = 4;
}

message ListUserEnvironmentPermissionsRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
}

message RemoveUserEnvironmentPermissionRequest {
  string workspace_name = 1;
  string project_name = 2;
  string environment_name = 3;
  string user_email = 4;
}

message UserPermission {
  string user_id = 1;
  string user_email = 2;
  Role role = 3;
}

message UserPermissionList {
  repeated UserPermission permissions = 1;
}

// Effective permissions messages
message GetEffectivePermissionsRequest {
  string workspace_name = 1;
  string principal_id = 2;
}

message EffectivePermissionsResponse {
  string principal_id = 1;
  string principal_name = 2;
  bool is_service_principal = 3;
  // Workspace-level effective role (if any)
  optional Role workspace_role = 4;
  // Project-level effective roles
  repeated EffectiveProjectPermission projects = 5;
}

message EffectiveProjectPermission {
  string project_id = 1;
  string project_name = 2;
  optional Role effective_role = 3;
  // Environment-level effective roles within this project
  repeated EffectiveEnvironmentPermission environments = 4;
}

message EffectiveEnvironmentPermission {
  string environment_id = 1;
  string environment_name = 2;
  Role effective_role = 3;
}

// Audit log messages
message AuditLogEntry {
  string id = 1;
  string timestamp = 2;
  string principal_id = 3;
  optional string user_id = 4;
  string action = 5;
  string resource_type = 6;
  string resource_id = 7;
  optional string workspace_id = 8;
  optional string project_id = 9;
  optional string environment_id = 10;
  string result = 11;
  optional string reason = 12;
  optional string details = 13; // JSON string
  optional string client_ip = 14;
}

message AuditLogList {
  repeated AuditLogEntry entries = 1;
  uint64 total_count = 2;
}

message ListAuditLogsRequest {
  string workspace_name = 1;
  optional string principal_id = 2;
  optional string user_id = 3;
  optional string project_name = 4;
  optional string environment_name = 5;
  optional string action = 6;
  optional string result = 7;
  optional string from_timestamp = 8;
  optional string to_timestamp = 9;
  optional uint32 limit = 10;
  optional uint32 offset = 11;
}

message GetAuditLogRequest {
  string workspace_name = 1;
  string audit_log_id = 2;
}

message CountAuditLogsRequest {
  string workspace_name = 1;
  optional string principal_id = 2;
  optional string user_id = 3;
  optional string project_name = 4;
  optional string environment_name = 5;
  optional string action = 6;
  optional string result = 7;
  optional string from_timestamp = 8;
  optional string to_timestamp = 9;
}

message CountAuditLogsResponse {
  uint64 count = 1;
}
