# Default values for zopp
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Server configuration
server:
  # Set to false to disable server deployment (operator-only mode)
  enabled: true

  replicaCount: 1

  image:
    repository: ghcr.io/faiscadev/zopp-server
    pullPolicy: IfNotPresent
    tag: "" # Overrides the image tag whose default is the chart appVersion

  service:
    type: ClusterIP
    grpcPort: 50051
    httpPort: 8080

  # Database configuration
  database:
    # Type: sqlite or postgres
    type: sqlite

    # For SQLite (file-based)
    sqlite:
      # Path where SQLite database will be stored
      path: /data/zopp.db
      # Persistent volume claim for SQLite data
      persistence:
        enabled: true
        storageClass: ""
        accessMode: ReadWriteOnce
        size: 1Gi

    # For PostgreSQL
    postgres:
      # External PostgreSQL connection string
      # Example: postgres://user:password@host:5432/database
      url: ""
      # OR use existing secret
      existingSecret: ""
      existingSecretKey: "DATABASE_URL"

  # Event bus configuration (for WatchSecrets streaming)
  events:
    # Backend type: auto, memory, or postgres
    # - auto (default): uses postgres if database.type=postgres, otherwise memory
    # - memory: in-memory only (single replica)
    # - postgres: PostgreSQL LISTEN/NOTIFY (required for horizontal scaling)
    backend: auto
    # Optional: separate database URL for events (defaults to main DATABASE_URL)
    # Useful for load isolation or using a read replica
    databaseUrl: ""
    existingSecret: ""
    existingSecretKey: "EVENTS_DATABASE_URL"

  # TLS configuration (optional)
  tls:
    enabled: false
    # Existing secret containing tls.crt, tls.key, and optionally ca.crt
    existingSecret: ""
    # OR provide inline
    cert: ""
    key: ""
    clientCA: ""

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  nodeSelector: {}
  tolerations: []
  affinity: {}

# Operator configuration
operator:
  # Set to false to disable operator deployment (server-only mode)
  enabled: true

  replicaCount: 1

  image:
    repository: ghcr.io/faiscadev/zopp-operator
    pullPolicy: IfNotPresent
    tag: "" # Overrides the image tag whose default is the chart appVersion

  # Server connection
  server:
    # gRPC server address
    # If server.enabled=true, this will be auto-generated as zopp-server:50051
    # If server.enabled=false, you MUST provide the external server address
    address: ""

    # TLS configuration for connecting to server
    tls:
      enabled: false
      # Existing secret containing ca.crt for server verification
      existingSecret: ""

  # Operator credentials
  credentials:
    # Existing secret containing operator credentials as environment variables.
    # The secret must have these keys: ZOPP_PRINCIPAL_ID, ZOPP_PRINCIPAL_NAME,
    # ZOPP_PRIVATE_KEY, ZOPP_PUBLIC_KEY, ZOPP_X25519_PRIVATE_KEY, ZOPP_X25519_PUBLIC_KEY
    #
    # Create with:
    #   kubectl create secret generic zopp-operator-credentials \
    #     --from-literal=ZOPP_PRINCIPAL_ID=<principal-id> \
    #     --from-literal=ZOPP_PRINCIPAL_NAME=<principal-name> \
    #     --from-literal=ZOPP_PRIVATE_KEY=<private-key-base64> \
    #     --from-literal=ZOPP_PUBLIC_KEY=<public-key-base64> \
    #     --from-literal=ZOPP_X25519_PRIVATE_KEY=<x25519-private-key-base64> \
    #     --from-literal=ZOPP_X25519_PUBLIC_KEY=<x25519-public-key-base64>
    existingSecret: ""
    # OR create from inline principal data (chart will generate the secret)
    principal:
      id: ""
      name: ""
      publicKey: ""
      x25519PublicKey: ""
      privateKey: ""
      x25519PrivateKey: ""

  # Kubernetes namespace to watch
  # Empty string means all namespaces (requires cluster-wide RBAC)
  # Set to a specific namespace (e.g., "default") for namespace-scoped operator
  watchNamespace: ""

  # Health check configuration
  healthCheck:
    port: 8080

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 64Mi

  nodeSelector: {}
  tolerations: []
  affinity: {}

# RBAC configuration
rbac:
  # Create RBAC resources
  create: true

  # For cluster-wide operator (watchNamespace: "")
  # Set to false for namespace-scoped operator (when watchNamespace is set)
  clusterWide: true

# ServiceAccount configuration
serviceAccount:
  # Create service account
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

podAnnotations: {}
podSecurityContext: {}
securityContext: {}

# Autoscaling configuration (HPA)
autoscaling:
  server:
    enabled: false
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80
  operator:
    enabled: false
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80

# Pod Disruption Budget
podDisruptionBudget:
  server:
    enabled: false
    # Either minAvailable or maxUnavailable (not both)
    minAvailable: 1
    # maxUnavailable: 1
  operator:
    enabled: false
    minAvailable: 1

# Network Policy
networkPolicy:
  enabled: false
  # Allow ingress from these namespaces (labels)
  # Empty means allow from same namespace only
  ingressNamespaceSelector: {}
  # Allow ingress from specific pod selectors
  ingressPodSelector: {}
  # Allow egress to specific CIDRs (for external database)
  egressCIDRs: []
  # Allow egress to specific ports (e.g., PostgreSQL)
  egressPorts:
    - port: 5432
      protocol: TCP

# Prometheus ServiceMonitor
serviceMonitor:
  enabled: false
  # Namespace where Prometheus is deployed
  namespace: ""
  # Additional labels for ServiceMonitor
  labels: {}
  # Scrape interval
  interval: 30s
  # Scrape timeout
  scrapeTimeout: 10s
  # Path for metrics endpoint
  path: /metrics
  # Port name for metrics endpoint
  port: http
